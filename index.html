<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Familien- & Wochenplaner — Card-Stack</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    /* === Design-Token (hell, rund, edel & modern) === */
    :root{
      --bg:#f5f7fb;                 /* helles Grundlayout */
      --bg-2:#eef1f7;                /* zarte Flächen */
      --card:#ffffff;                /* Kartenfläche */
      --card-2:#ffffff;              /* Pane-Fläche */
      --text:#0f172a;                /* Primärtext (sehr dunkelblau) */
      --muted:#6b7280;               /* Sekundärtext */
      --border:rgba(15, 23, 42, .08);/* feine Konturen */
      --accent:#0ea5e9;              /* Cyan/Blau (modern) */
      --accent-2:#6366f1;            /* Indigo */
      --accent-3:#10b981;            /* Smaragd */
      --rot:#ef4444; --blau:#2563eb; --gelb:#f59e0b; --gruen:#16a34a; --orange:#fb923c;
      --radius-xl:22px; --radius-lg:18px; --radius-md:14px; --radius-sm:12px;
      --shadow-1:0 10px 25px rgba(2,6,23,.06);
      --shadow-2:0 24px 60px rgba(2,6,23,.10);
      --ring:0 0 0 2px rgba(14,165,233,.18);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Inter',sans-serif; color:var(--text); overflow:hidden; -webkit-tap-highlight-color:transparent;
      background:linear-gradient(180deg,var(--bg),var(--bg-2));
    }
    .wrap{display:flex;flex-direction:column;gap:14px;height:100%;padding:14px}

    /* === Card-Stack / Carousel === */
    .carousel{position:relative;flex:1;overflow:auto;scroll-snap-type:x mandatory;display:flex;gap:14px;scroll-behavior:smooth;-webkit-overflow-scrolling:touch}
    .slide{scroll-snap-align:center;flex:0 0 100%;height:100%;will-change:transform}
    .card{height:100%;background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(255,255,255,.86));
      border:1px solid var(--border);border-radius:var(--radius-xl);padding:18px;display:grid;grid-template-rows:auto 1fr;gap:12px;transition:transform .2s ease-out, box-shadow .2s ease-out;box-shadow:var(--shadow-1)}
    .slide.active .card{transform:translateY(-2px) scale(1.01); box-shadow:var(--shadow-2)}

    .hero{display:flex;align-items:center;justify-content:space-between}
    .hero .title{font-size:24px;font-weight:800;background:linear-gradient(90deg,var(--accent),var(--accent-2));-webkit-background-clip:text;background-clip:text;color:transparent}
    .hero .date{font-size:14px;color:var(--muted)}

    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px;height:100%}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}

    /* === Pane / Tables === */
    .pane{background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(255,255,255,.88));
      border:1px solid var(--border);border-radius:var(--radius-lg);padding:12px;display:flex;flex-direction:column;min-height:0}
    .pane h4{margin:0 0 10px;font-size:15px;font-weight:700;color:#111827}
    .inner{flex:1;min-height:0;overflow:auto;border-radius:12px}

    table{border-collapse:separate;border-spacing:0;width:100%;border-radius:12px;overflow:hidden;background:#fff}
    th,td{padding:10px;border:1px solid var(--border);text-align:center;font-size:13px}
    thead tr{background:#f3f6fb}

    /* Fach-Tags als pastellige Chips */
    .fach-mathe{background:rgba(37,99,235,.12);color:#1e3a8a}
    .fach-deutsch{background:rgba(99,102,241,.12);color:#3730a3}
    .fach-englisch{background:rgba(245,158,11,.16);color:#7c2d12}
    .fach-musik{background:rgba(16,185,129,.14);color:#065f46}
    .fach-kunst{background:rgba(14,165,233,.14);color:#0c4a6e}
    .fach-sachkunde{background:rgba(251,146,60,.16);color:#7c2d12}

    /* Events als edle Karten mit Farbstreifen */
    ul.events{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:8px}
    .event{background:#fff;border:1px solid var(--border);border-radius:14px;padding:10px 12px;font-size:13px;box-shadow:var(--shadow-1);position:relative}
    .event::before{content:"";position:absolute;left:0;top:0;bottom:0;width:4px;border-top-left-radius:14px;border-bottom-left-radius:14px;background:linear-gradient(180deg,var(--accent),var(--accent-2))}
    .event .time{font-weight:800;margin-right:6px}
    .status{font-size:12px;color:var(--muted);margin-top:8px}

    /* === Widgets (App-Logos als Vollfläche) === */
    .widgets{display:grid;gap:12px;grid-template-columns:repeat(4,1fr)}
    @media(max-width:1200px){.widgets{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:700px){.widgets{grid-template-columns:1fr}}

    .app-tile{position:relative;border-radius:18px;overflow:hidden;background:#fff;border:1px solid var(--border);box-shadow:var(--shadow-1);aspect-ratio:1/1;display:flex}
    .app-link{flex:1;display:flex;align-items:center;justify-content:center;outline:none}
    .app-link:focus-visible{box-shadow:var(--ring)}
    .app-logo{width:100%;height:100%;object-fit:contain}

    /* === Nav === */
    .nav{position:absolute;inset:0;pointer-events:none}
    .arrow{position:absolute;top:50%;transform:translateY(-50%);background:#fff;border:1px solid var(--border);padding:10px;border-radius:999px;pointer-events:auto;cursor:pointer;box-shadow:var(--shadow-1)}
    .arrow.left{left:10px}.arrow.right{right:10px}
    .dots{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);display:flex;gap:8px}
    .dot{width:8px;height:8px;border-radius:999px;background:rgba(2,6,23,.18)}.dot.active{background:linear-gradient(90deg,var(--accent),var(--accent-2))}

    /* === Bubbles === */
    .fixed-thumb{position:fixed;right:12px;background:#ffffffcc;border:1px solid var(--border);border-radius:14px;padding:12px 16px;box-shadow:var(--shadow-2);cursor:pointer;z-index:50;user-select:none;width:120px;text-align:center;backdrop-filter:saturate(140%) blur(8px)}
    .fixed-thumb .label{font-weight:800}
    .fixed-thumb .hint{font-size:10px;opacity:.7;margin-top:6px}
    #fixedThumb{top:40%}#monthThumb{top:56%}

    /* === Modals === */
    .modal{position:fixed;inset:0;background:rgba(15,23,42,.25);display:none;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(2px)}
    .modal.open{display:flex}#fixedModal{z-index:110}#monthModal{z-index:90}
    .dialog{position:relative;background:#fff;border:1px solid var(--border);border-radius:20px;padding:16px;width:1200px;max-width:95vw;max-height:85vh;overflow:auto;box-shadow:var(--shadow-2)}
    .close-x{position:absolute;top:14px;right:18px;background:#fff;border:1px solid var(--border);padding:6px 10px;border-radius:999px;cursor:pointer;box-shadow:var(--shadow-1)}

    /* Accessibility / Motion */
    @media (prefers-reduced-motion: reduce){
      .carousel{scroll-behavior:auto}
      .card{transition:none}
    }
      /* === Kompakte App-Kacheln (klein & edel) === */
    .widgets{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(120px,1fr))}
    .app-tile{background:#fff;border:1px solid var(--border);border-radius:16px;padding:12px;display:flex;flex-direction:column;align-items:center;gap:8px;box-shadow:var(--shadow-1);max-width:160px;justify-self:center}
    .app-link{display:flex;flex-direction:column;align-items:center;gap:8px;text-decoration:none}
    .app-badge{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;color:#0f172a;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#fff;box-shadow:0 6px 16px rgba(2,6,23,.12)}
    .app-title{font-size:12px;font-weight:700;color:#0f172a;text-align:center}
    @media(min-width:1400px){.widgets{grid-template-columns:repeat(auto-fit,minmax(130px,1fr))}.app-tile{max-width:150px}}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Swipe Cards: Heute & Morgen -->
    <div class="carousel" id="carousel" aria-label="Tageskarten">
      <!-- Heute -->
      <section class="slide" aria-roledescription="slide" aria-label="Heute">
        <div class="card">
          <div class="hero"><div class="title">Heute</div><div class="date" id="date-today"></div></div>
          <div class="grid">
            <div class="pane">
              <h4>Stundenplan · Heute</h4>
              <div class="inner">
                <table><thead><tr><th>Zeit</th><th>Fach</th><th>Raum</th></tr></thead>
                <tbody id="stundenplan-heute"></tbody></table>
              </div>
            </div>
            <div class="pane">
              <h4>Valentin · Termine · Heute</h4>
              <div class="inner">
                <ul class="events" id="valentin-today-list"></ul>
                <div class="status" id="valentin-today-status"></div>
              </div>
            </div>
          </div>
        </div>
      </section>
      <!-- Morgen -->
      <section class="slide" aria-roledescription="slide" aria-label="Morgen">
        <div class="card">
          <div class="hero"><div class="title">Morgen</div><div class="date" id="date-tomorrow"></div></div>
          <div class="grid">
            <div class="pane">
              <h4>Stundenplan · Morgen</h4>
              <div class="inner">
                <table><thead><tr><th>Zeit</th><th>Fach</th><th>Raum</th></tr></thead>
                <tbody id="stundenplan-morgen"></tbody></table>
              </div>
            </div>
            <div class="pane">
              <h4>Valentin · Termine · Morgen</h4>
              <div class="inner">
                <ul class="events" id="valentin-tomorrow-list"></ul>
                <div class="status" id="valentin-tomorrow-status"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Nav overlays -->
      <div class="nav" aria-hidden="true">
        <div class="arrow left" id="prev" title="Zurück">‹</div>
        <div class="arrow right" id="next" title="Weiter">›</div>
        <div class="dots"><div class="dot active" id="dot0"></div><div class="dot" id="dot1"></div></div>
      </div>
    </div>

    <!-- Smart Home Widgets -->
    <section>
      <div class="widgets" id="widgets"></div>
    </section>
  </div>

  <!-- Bubble: Fixer Stundenplan -->
  <div class="fixed-thumb" id="fixedThumb" title="Fixen Stundenplan vergrößern">
    <div class="label">Stundenplan</div>
    <div class="hint">Tippen zum Vergrößern</div>
  </div>
  <div class="modal" id="fixedModal" role="dialog" aria-modal="true" aria-label="Fixer Stundenplan">
    <div class="dialog">
      <div class="close-x" id="closeModal">Schließen ✕</div>
      <h3>Fixer Stundenplan (Schuljahr)</h3>
      <div class="pane" style="padding:8px">
        <div class="inner" style="overflow:auto">
          <table>
            <thead><tr><th>Zeit</th><th>Mo</th><th>Di</th><th>Mi</th><th>Do</th><th>Fr</th></tr></thead>
            <tbody id="stundenplan-fix"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Bubble: Monatskalender (kombiniert) -->
  <div class="fixed-thumb" id="monthThumb" title="Monatskalender">
    <div class="label">Kalender</div>
    <div class="hint">Monatsansicht</div>
  </div>
  <div class="modal" id="monthModal" role="dialog" aria-modal="true" aria-label="Monatskalender">
    <div class="dialog">
      <div class="close-x" id="closeMonth">Schließen ✕</div>
      <h3>Alle Kalender · Monatsansicht</h3>
      <div class="pane" style="padding:0">
        <iframe id="monthFrame" height="600"></iframe>
      </div>
    </div>
  </div>

<script>
/* ===== KONFIG ===== */
const APPS_SCRIPT_URL='https://script.google.com/macros/s/AKfycbyw8-Ns-eaFBpr_aMXYxx8RNujRoZ3X89Txu61Zqf9N_TiO1xGviCLB9hqtKnYUeBdk/exec';
const CAL={VALENTIN:'057e175cb88528446a3b90c6e6ff1124f870e0d6b97ded0da00e1fce8e509188@group.calendar.google.com',GENERAL:'gabstaschill@gmail.com',DIENST:'emujcvc9sc89j8gi2l9kdvf1i0@group.calendar.google.com'};
const TZ='Europe/Berlin';
const APPS=[
  // Hinweis: Ersetze 'icon' durch DEINE lokalen Pfade (z.B. ./icons/hue.png) für Offline-Betrieb.
  {title:'Philips Hue',pkg:'com.philips.lighting.hue2',intent:'intent://com.philips.lighting.hue2/#Intent;scheme=app;package=com.philips.lighting.hue2;end',icon:'https://upload.wikimedia.org/wikipedia/commons/1/16/Philips_Hue_logo.svg'},
  {title:'Sonos',pkg:'com.sonos.acr2',intent:'intent://com.sonos.acr2/#Intent;scheme=app;package=com.sonos.acr2;end',icon:'https://upload.wikimedia.org/wikipedia/commons/7/71/Sonos_2015_logo.svg'},
  {title:'tado°',pkg:'com.tado',intent:'intent://com.tado/#Intent;scheme=app;package=com.tado;end',icon:'https://upload.wikimedia.org/wikipedia/commons/2/2b/Tado_logo.svg'},
  {title:'eufy Security',pkg:'com.oceanwing.battery.cam',intent:'intent://com.oceanwing.battery.cam/#Intent;scheme=app;package=com.oceanwing.battery.cam;end',icon:'https://upload.wikimedia.org/wikipedia/commons/1/1f/Eufy_logo.svg'}
];

/* ===== Helpers ===== */
const $=s=>document.querySelector(s);
const $$=s=>document.querySelectorAll(s);
const toTimeStr=d=>new Date(d).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit',timeZone:TZ});
const isoDate=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const buildEmbed=p=>`https://calendar.google.com/calendar/embed?${['ctz='+encodeURIComponent(TZ),'showTitle=0','showPrint=0','showCalendars=0','showTz=0','wkst=2',...p].join('&')}`;

/* ===== Swipe Controls (rAF + passive) ===== */
(()=>{
  const el=$('#carousel'),dot0=$('#dot0'),dot1=$('#dot1'),prev=$('#prev'),next=$('#next');
  const idx=()=>Math.round(el.scrollLeft/el.clientWidth);
  const sync=()=>{const i=idx();dot0.classList.toggle('active',i===0);dot1.classList.toggle('active',i===1)};
  prev.addEventListener('click',()=>el.scrollTo({left:0,behavior:'smooth'}),{passive:true});
  next.addEventListener('click',()=>el.scrollTo({left:el.clientWidth,behavior:'smooth'}),{passive:true});
  let raf=0; const onScroll=()=>{cancelAnimationFrame(raf);raf=requestAnimationFrame(sync)};
  el.addEventListener('scroll',onScroll,{passive:true});

  // Subtile Aktiv-Animation via IntersectionObserver (nur Klassen toggeln)
  const io=new IntersectionObserver((entries)=>{
    for(const e of entries){e.target.classList.toggle('active',e.isIntersecting)}
  },{root:el,threshold:0.6});
  $$('.slide').forEach(s=>io.observe(s));
})();

/* ===== Daten füllen ===== */
function fillDates(){
  const now=new Date(),tmr=new Date(now);tmr.setDate(now.getDate()+1);
  $('#date-today').textContent=now.toLocaleDateString('de-DE',{weekday:'long',day:'2-digit',month:'2-digit'});
  $('#date-tomorrow').textContent=tmr.toLocaleDateString('de-DE',{weekday:'long',day:'2-digit',month:'2-digit'});
}

/* ===== Tages-Termine (heute/morgen, nur echte Tages-Termine) ===== */
let aborters={today:null,tomorrow:null};
async function loadDayEvents(listEl,statusEl,calId,iso,key){
  // Cancel previous request to avoid race conditions
  try{aborters[key]?.abort()}catch{}
  const controller=new AbortController(); aborters[key]=controller;
  try{
    statusEl.textContent='Lade Termine…';
    const url=`${APPS_SCRIPT_URL}?cal=${encodeURIComponent(calId)}&from=${iso}T00:00:00&to=${iso}T23:59:59`;
    const res=await fetch(url,{signal:controller.signal,cache:'no-store'});
    if(!res.ok) throw new Error(res.status);
    const data=await res.json();
    const frag=document.createDocumentFragment();
    if(Array.isArray(data)&&data.length){
      data.sort((a,b)=>new Date(a.start)-new Date(b.start));
      for(const ev of data){
        const li=document.createElement('li'); li.className='event';
        const time=document.createElement('span'); time.className='time';
        time.textContent=ev.allDay?'Ganztägig':`${toTimeStr(ev.start)}–${toTimeStr(ev.end)}`;
        const txt=document.createElement('span'); txt.textContent=` ${ev.summary||''}`;
        li.append(time,txt); frag.appendChild(li);
      }
      listEl.replaceChildren(frag);
      statusEl.textContent='';
    } else { listEl.replaceChildren(); statusEl.textContent='Keine Termine.' }
  }catch(err){ if(err?.name!=='AbortError'){ statusEl.textContent='Fehler beim Laden.' } }
}

/* ===== Demo-Stundenpläne / Fix-Plan ===== */
function renderStundenplaene(){
  $('#stundenplan-heute').innerHTML=`<tr><td>08:00–08:45</td><td class="fach-mathe">Mathematik</td><td>101</td></tr>
  <tr><td>09:00–09:45</td><td class="fach-englisch">Englisch</td><td>204</td></tr>
  <tr><td>10:00–10:45</td><td class="fach-deutsch">Deutsch</td><td>112</td></tr>`;
  $('#stundenplan-morgen').innerHTML=`<tr><td>08:00–08:45</td><td class="fach-deutsch">Deutsch</td><td>101</td></tr>
  <tr><td>09:00–09:45</td><td class="fach-mathe">Mathematik</td><td>204</td></tr>
  <tr><td>10:00–10:45</td><td class="fach-musik">Musik</td><td>Saal</td></tr>`;
}
function renderFixedPlan(){
  const rows=[
    {time:'08:00–08:45',mo:'Mathe',moCls:'fach-mathe',di:'Deutsch',diCls:'fach-deutsch',mi:'Englisch',miCls:'fach-englisch',do:'Mathe',doCls:'fach-mathe',fr:'Musik',frCls:'fach-musik'},
    {time:'09:00–09:45',mo:'Englisch',moCls:'fach-englisch',di:'Musik',diCls:'fach-musik',mi:'Deutsch',miCls:'fach-deutsch',do:'Kunst',doCls:'fach-kunst',fr:'Mathe',frCls:'fach-mathe'}
  ].map(r=>`<tr><td>${r.time}</td><td class="${r.moCls}">${r.mo}</td><td class="${r.diCls}">${r.di}</td><td class="${r.miCls}">${r.mi}</td><td class="${r.doCls}">${r.do}</td><td class="${r.frCls}">${r.fr}</td></tr>`).join('');
  $('#stundenplan-fix').innerHTML=rows;
}

/* ===== Smart Home ===== */
function renderSmartHome(){
  const wrap=$('#widgets');
  const frag=document.createDocumentFragment();
  for(const app of APPS){
    const tile=document.createElement('div'); tile.className='app-tile';

    const link=document.createElement('a');
    link.className='app-link';
    link.href=app.intent; link.target='_self'; link.rel='noopener';
    link.title=app.title; link.setAttribute('aria-label',app.title);

    // runde Badge mit Initialen statt externer Icons (performant & konsistent)
    const badge=document.createElement('div');
    badge.className='app-badge';
    badge.textContent=(app.title||'')[0]?.toUpperCase()||'·';

    const label=document.createElement('div');
    label.className='app-title';
    label.textContent=app.title;

    link.addEventListener('click',ev=>{ try{
      if(window.fully && typeof fully.startApplication==='function'){
        fully.startApplication(app.pkg); ev.preventDefault(); return;
      }
      setTimeout(()=>{ try{ location.href=app.intent }catch{} },0);
    }catch{} });

    link.append(badge,label);
    tile.append(link);
    frag.append(tile);
  }
  wrap.replaceChildren(frag);
}

/* ===== Modals ===== */
function wireModals(){
  const fm=$('#fixedModal'), ft=$('#fixedThumb'), fx=$('#closeModal');
  const mm=$('#monthModal'), mt=$('#monthThumb'), mx=$('#closeMonth');
  const toggleF=()=>fm.classList.toggle('open');
  const toggleM=()=>{ mm.classList.toggle('open'); if(mm.classList.contains('open')) $('#monthFrame').src=buildEmbed(['mode=MONTH','src='+encodeURIComponent(CAL.GENERAL),'src='+encodeURIComponent(CAL.DIENST),'src='+encodeURIComponent(CAL.VALENTIN)]) };
  ft.addEventListener('click',toggleF);
  fx.addEventListener('click',toggleF);
  fm.addEventListener('click',e=>{ if(e.target===fm) toggleF() });
  mt.addEventListener('click',toggleM);
  mx.addEventListener('click',toggleM);
  mm.addEventListener('click',e=>{ if(e.target===mm) toggleM() });
}

/* ===== Heute/Morgen laden ===== */
function refreshDays(){
  const now=new Date(), tmr=new Date(now); tmr.setDate(now.getDate()+1);
  loadDayEvents($('#valentin-today-list'),$('#valentin-today-status'),CAL.VALENTIN,isoDate(now),'today');
  loadDayEvents($('#valentin-tomorrow-list'),$('#valentin-tomorrow-status'),CAL.VALENTIN,isoDate(tmr),'tomorrow');
}

/* ===== Init ===== */
(function init(){ fillDates(); renderStundenplaene(); renderFixedPlan(); renderSmartHome(); wireModals(); refreshDays(); })();

// Auto-Refresh (5 Minuten)
setInterval(()=>{ try{ refreshDays() }catch{} },5*60*1000);
</script>
</body>
</html>
