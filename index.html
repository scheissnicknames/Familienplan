<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Familien- & Wochenplaner</title>
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#1f2937; --text:#e5e7eb;
      --rot:#ef4444; --blau:#3b82f6; --gelb:#facc15; --gruen:#22c55e; --orange:#fb923c;
      --radius:14px; --border:#223046;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{padding:12px 14px;text-align:center;font-weight:800;border-bottom:1px solid var(--border)}
    .wrap{padding:12px;display:grid;gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:10px}
    .card h3{margin:0 0 8px 0;font-size:15px}
    .grid2{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    @media (max-width:900px){.grid2{grid-template-columns:1fr}}
    .box{border:1px solid var(--border);border-radius:10px;padding:8px;background:var(--muted)}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid var(--border);padding:6px;text-align:center;font-size:13px}
    thead tr{background:#162032}
    /* F√§cherfarben */
    .fach-mathe{background:var(--rot);color:#fff}
    .fach-deutsch{background:var(--blau);color:#fff}
    .fach-englisch{background:var(--gelb);color:#111}
    .fach-musik{background:var(--gruen);color:#021}
    .fach-kunst{background:var(--blau);color:#fff}
    .fach-sachkunde{background:var(--orange);color:#211}
    /* Widgets */
    .widgets{display:grid;gap:10px;grid-template-columns:repeat(4,1fr)}
    @media (max-width:1100px){.widgets{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){.widgets{grid-template-columns:1fr}}
    .tile{background:var(--muted);border:1px solid var(--border);border-radius:12px;padding:10px}
    .tile h4{margin:0 0 8px 0;font-size:14px}
    .btnrow{display:flex;gap:8px;flex-wrap:wrap}
    .btn{display:inline-block;border:1px solid #2a3a58;background:#192233;color:#fff;border-radius:10px;padding:8px 10px;font-weight:600;font-size:13px;cursor:pointer;text-decoration:none}
    .btn:active{transform:translateY(1px)}
    /* Fixer Stundenplan: Thumbnail + Modal */
    .fixed-thumb{position:fixed;right:10px;top:50%;transform:translateY(-50%);background:#192233;border:1px solid var(--border);border-radius:12px;padding:10px 14px;cursor:pointer;user-select:none}
    .fixed-thumb .label{font-weight:800;letter-spacing:.3px}
    .fixed-thumb .hint{font-size:10px;opacity:.7;text-align:center;margin-top:6px}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center}
    .modal.open{display:flex}
    .dialog{background:var(--card);border:1px solid var(--border);border-radius:16px;max-width:95vw;max-height:85vh;overflow:auto;padding:12px;position:relative}
    .close-x{position:absolute;top:10px;right:12px;border:1px solid #2a3a58;background:#192233;border-radius:999px;padding:6px 10px;cursor:pointer}
    /* Agenda Liste */
    .agenda-list{list-style:none;margin:8px 0 0 0;padding:0}
    .agenda-day{margin-top:10px;border-top:1px solid var(--border);padding-top:8px}
    .agenda-day h4{margin:0 0 6px 0;font-size:13px}
    .agenda-item{padding:4px 0;font-size:13px}
    .muted{color:#9ca3af}
    .error{color:#fca5a5;font-size:12px;margin-top:4px}
    iframe{width:100%;border:0;display:block}
    /* Diagnose-Badge */
    .diag{position:fixed;left:10px;bottom:10px;background:#192233;border:1px solid var(--border);border-radius:10px;padding:6px 8px;font-size:11px;opacity:.85}
  </style>
</head>
<body>
<header>üìÖ Familien- & Wochenplaner</header>
<div class="wrap">

  <!-- Heute / Morgen -->
  <div class="grid2">
    <section class="card">
      <h3>Heute ¬∑ Valentin</h3>
      <div class="box">
        <table>
          <thead><tr><th>Zeit</th><th>Fach</th><th>Raum</th></tr></thead>
          <tbody id="stundenplan-heute"></tbody>
        </table>
      </div>
      <div class="box" style="margin-top:8px">
        <strong>Termine ¬∑ Heute</strong>
        <ul id="valentin-today-list" style="list-style:none;margin:6px 0 0 0;padding:0"></ul>
        <div id="valentin-today-status" class="muted" style="margin-top:4px"></div>
        <div id="valentin-today-fallback" style="display:none;margin-top:6px">
          <iframe id="valentin-today" height="180"></iframe>
        </div>
      </div>
    </section>

    <section class="card">
      <h3>Morgen ¬∑ Valentin</h3>
      <div class="box">
        <table>
          <thead><tr><th>Zeit</th><th>Fach</th><th>Raum</th></tr></thead>
          <tbody id="stundenplan-morgen"></tbody>
        </table>
      </div>
      <div class="box" style="margin-top:8px">
        <strong>Termine ¬∑ Morgen</strong>
        <ul id="valentin-tomorrow-list" style="list-style:none;margin:6px 0 0 0;padding:0"></ul>
        <div id="valentin-tomorrow-status" class="muted" style="margin-top:4px"></div>
      </div>
    </section>
  </div>

  <!-- Agenda 7 Tage (Apps Script) -->
  <section class="card">
    <h3>Agenda ¬∑ n√§chste 7 Tage ¬∑ alle Kalender</h3>
    <div class="box">
      <div id="combined-status" class="muted">Lade Agenda‚Ä¶</div>
      <div id="combined-errors"></div>
      <ul id="combined-agenda" class="agenda-list"></ul>
    </div>
    <div class="muted" style="margin-top:6px">
      Script-Account braucht Leserechte auf Allgemein, Dienst, (optional) Geburtstage, Valentin. CORS im Script aktiv.
    </div>
  </section>

  <!-- Smart Home -->
  <section class="card">
    <h3>Smart Home</h3>
    <div class="widgets" id="widgets"></div>
  </section>

</div>

<!-- Fixer Stundenplan Thumbnail + Modal -->
<div class="fixed-thumb" id="fixedThumb" title="Fixen Stundenplan vergr√∂√üern">
  <div class="label">Stundenplan</div>
  <div class="hint">Tippen zum Vergr√∂√üern</div>
</div>
<div class="modal" id="fixedModal">
  <div class="dialog">
    <button class="close-x" id="closeModal">Schlie√üen ‚úï</button>
    <h3>Fixer Stundenplan (Schuljahr)</h3>
    <div class="box" style="margin-top:6px">
      <table>
        <thead><tr><th>Zeit</th><th>Mo</th><th>Di</th><th>Mi</th><th>Do</th><th>Fr</th></tr></thead>
        <tbody id="stundenplan-fix"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Diagnose -->
<div class="diag" id="diag">Fully JS verf√ºgbar: nein</div>

<script>
/* ====== KONFIG ====== */
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyw8-Ns-eaFBpr_aMXYxx8RNujRoZ3X89Txu61Zqf9N_TiO1xGviCLB9hqtKnYUeBdk/exec';
const INCLUDE_BIRTHDAYS = false; // ‚Üê wenn Probleme: auf false lassen
const CAL = {
  VALENTIN:'057e175cb88528446a3b90c6e6ff1124f870e0d6b97ded0da00e1fce8e509188@group.calendar.google.com',
  GENERAL:'gabstaschill@gmail.com',
  DIENST:'emujcvc9sc89j8gi2l9kdvf1i0@group.calendar.google.com',
  BDAY:'addressbook#contacts@group.v.calendar.google.com'
};
/* App-Links: echte <a href="intent://..."> plus Fully-Start (wenn m√∂glich) */
const APPS = [
  { title:'Philips Hue',   pkg:'com.philips.lighting.hue2', intent:'intent://com.philips.lighting.hue2/#Intent;scheme=app;package=com.philips.lighting.hue2;end', label:'Hue √∂ffnen' },
  { title:'Sonos',         pkg:'com.sonos.acr2',            intent:'intent://com.sonos.acr2/#Intent;scheme=app;package=com.sonos.acr2;end',            label:'Sonos √∂ffnen' },
  { title:'tado¬∞',         pkg:'com.tado',                   intent:'intent://com.tado/#Intent;scheme=app;package=com.tado;end',                         label:'tado¬∞ √∂ffnen' },
  { title:'eufy Security', pkg:'com.oceanwing.battery.cam',  intent:'intent://com.oceanwing.battery.cam/#Intent;scheme=app;package=com.oceanwing.battery.cam;end', label:'eufy √∂ffnen' }
];

/* ====== Helpers ====== */
const $ = s => document.querySelector(s);
function toTimeStr(d){ return new Date(d).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'}); }
function ymd(d){ return d.getFullYear()+String(d.getMonth()+1).padStart(2,'0')+String(d.getDate()).padStart(2,'0'); }
function isoDate(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function dayKey(d){ return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; }

/* ====== Heute/Morgen ====== */
async function loadDayEvents(listEl,statusEl,fallbackBox,fallbackIframe,calId,iso,ymdStr){
  try{
    statusEl.textContent='Lade Termine‚Ä¶';
    const res=await fetch(`${APPS_SCRIPT_URL}?cal=${encodeURIComponent(calId)}&from=${iso}T00:00:00&to=${iso}T23:59:59`);
    if(!res.ok) throw new Error(res.status);
    const data=await res.json(); listEl.innerHTML='';
    if(Array.isArray(data) && data.length){
      data.sort((a,b)=>new Date(a.start)-new Date(b.start));
      data.forEach(ev=>{
        const li=document.createElement('li');
        const t=ev.allDay?'Ganzt√§gig':`${toTimeStr(ev.start)}‚Äì${toTimeStr(ev.end)}`;
        li.textContent=`${t} ¬∑ ${ev.summary||''}`; listEl.appendChild(li);
      });
      statusEl.textContent=''; if(fallbackBox) fallbackBox.style.display='none';
    } else {
      statusEl.textContent='Keine Termine.';
      if(fallbackBox && fallbackIframe){ fallbackIframe.src = googleAgendaDay(calId, ymdStr); fallbackBox.style.display='block'; }
    }
  }catch(e){
    statusEl.textContent='Fehler beim Laden.';
    if(fallbackBox && fallbackIframe){ fallbackIframe.src = googleAgendaDay(calId, ymdStr); fallbackBox.style.display='block'; }
  }
}
function googleAgendaDay(calId, ymdStr){
  const y=+ymdStr.slice(0,4), m=+ymdStr.slice(4,6)-1, d=+ymdStr.slice(6,8);
  const start=new Date(y,m,d); const end=new Date(start); end.setDate(start.getDate()+1);
  const endYMD = ymd(end);
  const common=['ctz=Europe/Berlin','showTitle=0','showPrint=0','showCalendars=0','showTz=0','wkst=2'];
  return 'https://calendar.google.com/calendar/embed?' + [...common, 'mode=AGENDA', `dates=${ymdStr}/${endYMD}`, 'src='+encodeURIComponent(calId)].join('&');
}

/* ====== Kombinierte 7-Tage-Agenda ====== */
async function loadCombinedAgenda(){
  const status = $('#combined-status');
  const list   = $('#combined-agenda');
  const errors = $('#combined-errors');
  status.textContent = 'Lade Agenda‚Ä¶'; list.innerHTML = ''; errors.innerHTML='';

  const start = new Date(); start.setHours(0,0,0,0);
  const end   = new Date(start); end.setDate(end.getDate()+7); end.setHours(23,59,59,999);

  const CALS = [
    {id:CAL.GENERAL,  label:'Allgemein'},
    {id:CAL.DIENST,   label:'Dienstplan'},
    ...(INCLUDE_BIRTHDAYS ? [{id:CAL.BDAY,label:'Geburtstage'}] : []),
    {id:CAL.VALENTIN, label:'Valentin'}
  ];

  const requests = CALS.map(c =>
    fetch(`${APPS_SCRIPT_URL}?cal=${encodeURIComponent(c.id)}&from=${isoDate(start)}T00:00:00&to=${isoDate(end)}T23:59:59`)
      .then(r => r.ok ? r.json() : Promise.reject('HTTP '+r.status))
      .then(arr => Array.isArray(arr) ? arr.map(e => ({...e, _cal:c.label})) : [])
      .catch(() => { const p=document.createElement('div'); p.className='error'; p.textContent=`‚ö†Ô∏è Kein Zugriff auf ‚Äû${c.label}‚Äú`; errors.appendChild(p); return []; })
  );
  const chunks = await Promise.all(requests);
  const all = chunks.flat();

  const byDay = {};
  for(let i=0;i<8;i++){ const d = new Date(start); d.setDate(start.getDate()+i); byDay[dayKey(d)] = { date: new Date(d), items: [] }; }
  all.forEach(ev=>{
    const d = new Date(ev.start);
    const key = dayKey(new Date(d.getFullYear(), d.getMonth(), d.getDate()));
    if(byDay[key]) byDay[key].items.push(ev);
  });

  const dayNames = ['So','Mo','Di','Mi','Do','Fr','Sa'];
  Object.values(byDay).sort((a,b)=>a.date-b.date).forEach(group=>{
    const h = document.createElement('li'); h.className='agenda-day';
    const label = `${dayNames[group.date.getDay()]} ${group.date.toLocaleDateString('de-DE')}`;
    h.innerHTML = `<h4>${label}</h4>`;
    if(group.items.length===0){
      const li = document.createElement('div'); li.className='agenda-item muted'; li.textContent='‚Äî'; h.appendChild(li);
    }else{
      group.items.sort((a,b)=>new Date(a.start)-new Date(b.start));
      group.items.forEach(ev=>{
        const li = document.createElement('div'); li.className='agenda-item';
        const t = ev.allDay ? 'Ganzt√§gig' : `${toTimeStr(ev.start)}‚Äì${toTimeStr(ev.end)}`;
        li.textContent = `${t} ¬∑ ${ev.summary||'(ohne Titel)'} (${ev._cal})`;
        h.appendChild(li);
      });
    }
    list.appendChild(h);
  });

  status.textContent = '';
}

/* ====== Stundenpl√§ne (Demo) ====== */
function renderStundenplaene(){
  $('#stundenplan-heute').innerHTML =
    `<tr><td>08:00‚Äì08:45</td><td class="fach-mathe">Mathematik</td><td>101</td></tr>
     <tr><td>09:00‚Äì09:45</td><td class="fach-englisch">Englisch</td><td>204</td></tr>
     <tr><td>10:00‚Äì10:45</td><td class="fach-deutsch">Deutsch</td><td>112</td></tr>`;
  $('#stundenplan-morgen').innerHTML =
    `<tr><td>08:00‚Äì08:45</td><td class="fach-deutsch">Deutsch</td><td>101</td></tr>
     <tr><td>09:00‚Äì09:45</td><td class="fach-mathe">Mathematik</td><td>204</td></tr>
     <tr><td>10:00‚Äì10:45</td><td class="fach-musik">Musik</td><td>Saal</td></tr>`;

  const fixedData=[
    {time:'08:00‚Äì08:45', mo:'Mathe', moCls:'fach-mathe', di:'Deutsch', diCls:'fach-deutsch', mi:'Englisch', miCls:'fach-englisch', do:'Mathe', doCls:'fach-mathe', fr:'Musik', frCls:'fach-musik'},
    {time:'09:00‚Äì09:45', mo:'Englisch', moCls:'fach-englisch', di:'Musik', diCls:'fach-musik', mi:'Deutsch', miCls:'fach-deutsch', do:'Kunst', doCls:'fach-kunst', fr:'Mathe', frCls:'fach-mathe'}
  ];
  const row = r => `<tr><td>${r.time}</td><td class="${r.moCls}">${r.mo}</td><td class="${r.diCls}">${r.di}</td><td class="${r.miCls}">${r.mi}</td><td class="${r.doCls}">${r.do}</td><td class="${r.frCls}">${r.fr}</td></tr>`;
  $('#stundenplan-fix').innerHTML = fixedData.map(row).join('');
}

/* ====== Fixed Modal ====== */
function wireFixedModal(){
  const modal=$('#fixedModal'), thumb=$('#fixedThumb'), close=$('#closeModal');
  const toggle=()=> modal.classList.toggle('open');
  thumb.addEventListener('click', toggle);
  close.addEventListener('click', toggle);
  modal.addEventListener('click', e=>{ if(e.target===modal) toggle(); });
}

/* ====== Smart Home Buttons ====== */
function renderSmartHome(){
  const root=$('#widgets');
  APPS.forEach(app=>{
    const card=document.createElement('div'); card.className='tile';
    const h=document.createElement('h4'); h.textContent=app.title; card.appendChild(h);
    const row=document.createElement('div'); row.className='btnrow';

    // 1) ECHTER <a>-Link mit intent:// (f√ºr WebViews die JS-redirect blocken)
    const a=document.createElement('a'); a.className='btn'; a.textContent=app.label; a.href=app.intent;

    // 2) Klick-Handler: zuerst Fully-Start, sonst l√§sst man den <a>-Intent laufen
    a.addEventListener('click', (ev)=>{
      const diag=$('#diag');
      try{
        if(window.fully && typeof fully.startApplication==='function'){
          fully.startApplication(app.pkg);
          ev.preventDefault(); // wir haben die App schon gestartet
          if(diag) diag.textContent='Fully JS verf√ºgbar: ja (per startApplication gestartet)';
        }else{
          if(diag) diag.textContent='Fully JS verf√ºgbar: nein (fallback intent://)';
          // kein preventDefault ‚Üí Browser/Fullys WebView √∂ffnet intent://
        }
      }catch(e){
        // falls Fully-Call crasht, lass Intent durch
        if(diag) diag.textContent='Fully JS Fehler ‚Äì fallback intent://';
      }
    });

    row.appendChild(a);
    card.appendChild(row);
    root.appendChild(card);
  });
}

/* ====== Heute/Morgen Refresh ====== */
function refreshTodayTomorrow(){
  const now = new Date();
  const TODAY_ISO = isoDate(now), TODAY_YMD = ymd(now);
  const tmr = new Date(now); tmr.setDate(now.getDate()+1);
  const TOMORROW_ISO = isoDate(tmr), TOMORROW_YMD = ymd(tmr);

  // HEUTE: Fallback-Iframe setzen (zeigt nur heute)
  const todayBox=$('#valentin-today-fallback');
  const todayIframe=$('#valentin-today');
  if(todayIframe){
    const end = new Date(now); end.setDate(now.getDate()+1);
    const endYMD = ymd(end);
    const common='ctz=Europe/Berlin&showTitle=0&showPrint=0&showCalendars=0&showTz=0&wkst=2&mode=AGENDA';
    todayIframe.src = `https://calendar.google.com/calendar/embed?${common}&dates=${TODAY_YMD}/${endYMD}&src=${encodeURIComponent(CAL.VALENTIN)}`;
    todayBox.style.display='block';
  }

  loadDayEvents($('#valentin-today-list'), $('#valentin-today-status'), todayBox, todayIframe, CAL.VALENTIN, TODAY_ISO, TODAY_YMD);
  loadDayEvents($('#valentin-tomorrow-list'), $('#valentin-tomorrow-status'), null, null, CAL.VALENTIN, TOMORROW_ISO, TOMORROW_YMD);
}

/* ====== Diagnose ====== */
function updateDiag(){
  const d=$('#diag');
  const ok = !!(window.fully && typeof fully.startApplication==='function');
  d.textContent = `Fully JS verf√ºgbar: ${ok ? 'ja' : 'nein'}`
}

/* ====== Init ====== */
renderStundenplaene();
renderSmartHome();
wireFixedModal();
refreshTodayTomorrow();
loadCombinedAgenda();
updateDiag();

/* Schonender Auto-Reload: 10 Minuten */
setInterval(()=>{ refreshTodayTomorrow(); loadCombinedAgenda(); updateDiag(); }, 10*60*1000);
</script>

<!-- Apps Script Reminder:
- doGet muss JSON + CORS (Access-Control-Allow-Origin: *) liefern.
- Script-Account braucht Leserechte auf: gabstaschill@gmail.com, Dienstplan, (optional) Geburtstage, Valentin.
- Nach √Ñnderungen: Deploy ‚Üí Manage deployments ‚Üí Update (Web app).
- Fully: Web Content ‚Üí Enable JavaScript Interface + Open URL Schemes in Other Apps aktivieren (f√ºr intent://).
-->
</body>
</html>
