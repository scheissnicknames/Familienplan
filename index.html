<!DOCTYPE html><html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Familien- & Wochenplaner</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a; --card:#0b1226; --card-2:#101a33; --text:#e5e7eb; --border:rgba(255,255,255,.08);
      --rot:#ef4444; --blau:#3b82f6; --gelb:#facc15; --gruen:#22c55e; --orange:#fb923c;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:'Inter',sans-serif;color:var(--text)}
    .wrap{padding:14px;display:grid;gap:14px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
          border:1px solid var(--border);border-radius:18px;padding:12px}
    .card h3{margin:0 0 10px;font-size:16px}
    .top-grid{display:grid;gap:14px;grid-template-columns:1fr 1fr}
    @media(max-width:900px){.top-grid{grid-template-columns:1fr}}
    table{border-collapse:separate;border-spacing:0;width:100%;border-radius:12px;overflow:hidden}
    th,td{padding:8px;border:1px solid var(--border);text-align:center;font-size:13px}
    thead tr{background:rgba(255,255,255,.05)}
    /* Fachfarben */
    .fach-mathe{background:var(--rot);color:#fff}
    .fach-deutsch{background:var(--blau);color:#fff}
    .fach-englisch{background:var(--gelb);color:#111}
    .fach-musik{background:var(--gruen);color:#fff}
    .fach-kunst{background:var(--blau);color:#fff}
    .fach-sachkunde{background:var(--orange);color:#111}
    .iframe-wrap{border:1px solid var(--border);border-radius:12px;background:var(--card-2);overflow:hidden}
    iframe{width:100%;border:0}
    /* Widgets */
    .widgets{display:grid;gap:12px;grid-template-columns:repeat(4,1fr)}
    @media(max-width:1200px){.widgets{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:700px){.widgets{grid-template-columns:1fr}}
    .tile{background:rgba(255,255,255,.04);border:1px solid var(--border);
          border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:8px}
    .tile h4{margin:0;font-size:14px}
    .btnrow{display:flex;flex-wrap:wrap;gap:8px}
    .btn{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);
         padding:8px 10px;border-radius:12px;font-size:13px;font-weight:600;color:#fff;cursor:pointer;text-decoration:none;display:inline-block}
    .btn:active{transform:translateY(1px)}/* Floating Bubbles (right side) */
.fixed-thumb{position:fixed;right:10px;background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.1);border-radius:12px;
  padding:10px 14px;box-shadow:0 10px 30px rgba(0,0,0,.35);
  cursor:pointer;z-index:50;user-select:none;width:110px;text-align:center}
.fixed-thumb .label{font-weight:800;letter-spacing:.3px}
.fixed-thumb .hint{font-size:10px;opacity:.7;text-align:center;margin-top:6px}

/* Positions: Kalender unter Stundenplan */
#fixedThumb{top:40%;}
#monthThumb{top:55%;}

/* Modals */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:100}
.modal.open{display:flex}
#fixedModal{z-index:110} /* Stundenplan über Kalender */
#monthModal{z-index:90}
.modal .dialog{position:relative;background:var(--card-2);border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:14px;max-width:95vw;max-height:85vh;overflow:auto;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.modal .dialog h3{margin:0 0 10px}
.close-x{position:absolute;top:14px;right:18px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);padding:6px 10px;border-radius:999px;cursor:pointer}

.note{font-size:12px;color:#cbd5e1;opacity:.8;margin-top:6px}
.agenda-list{list-style:none;margin:8px 0 0 0;padding:0}
.agenda-day{margin:10px 0 0 0;border-top:1px solid rgba(255,255,255,.08);padding-top:8px}
.agenda-day h4{margin:0 0 6px 0;font-size:13px;opacity:.9}
.agenda-item{padding:4px 0;font-size:13px}
.muted{color:#9ca3af}
.error{color:#fca5a5;font-size:12px}
.agenda-box{max-height:220px; overflow:auto}

/* Diagnose Badge */
.diag{position:fixed;left:10px;bottom:10px;background:#0b1226;border:1px solid var(--border);border-radius:10px;padding:6px 8px;font-size:11px;opacity:.9;z-index:200}

  </style>
</head>
<body>
<div class="wrap">  <!-- Heute/Morgen -->  <div class="top-grid">
    <section class="card">
      <h3>Heute · Valentin</h3>
      <div class="iframe-wrap" style="padding:6px">
        <table><thead><tr><th>Zeit</th><th>Fach</th><th>Raum</th></tr></thead>
        <tbody id="stundenplan-heute"></tbody></table>
      </div>
      <div class="iframe-wrap" style="padding:10px">
        <strong>Termine · Heute</strong>
        <ul id="valentin-today-list" style="list-style:none;padding:0;margin:6px 0 0 0"></ul>
        <div id="valentin-today-status" style="font-size:12px"></div>
        <div id="valentin-today-fallback" style="display:none;margin-top:6px"><iframe id="valentin-today" height="200"></iframe></div>
      </div>
    </section><section class="card">
  <h3>Morgen · Valentin</h3>
  <div class="iframe-wrap" style="padding:6px">
    <table><thead><tr><th>Zeit</th><th>Fach</th><th>Raum</th></tr></thead>
    <tbody id="stundenplan-morgen"></tbody></table>
  </div>
  <div class="iframe-wrap" style="padding:10px">
    <strong>Termine · Morgen</strong>
    <ul id="valentin-tomorrow-list" style="list-style:none;padding:0;margin:6px 0 0 0"></ul>
    <div id="valentin-tomorrow-status" style="font-size:12px"></div>
  </div>
</section>

  </div>  <!-- Agenda 7 Tage (eigene Liste) -->  <section class="card">
    <h3>Agenda · nächste 7 Tage · alle Kalender</h3>
    <div class="iframe-wrap agenda-box" style="padding:10px">
      <div id="combined-status" class="muted">Lade Agenda…</div>
      <div id="combined-errors"></div>
      <ul id="combined-agenda" class="agenda-list"></ul>
    </div>
    <div class="note">
      Lädt serverseitig über dein Apps Script (kein Google-Login am Tablet nötig). Wenn Fehler angezeigt werden, fehlen dem Script-Account vermutlich die Leserechte auf einen der Kalender oder CORS ist nicht aktiv.
    </div>
  </section>  <!-- Smart Home Widgets (Fully JS + Intent-Fallback) -->  <section class="card">
    <h3>Smart Home</h3>
    <div class="widgets" id="widgets"></div>
  </section></div><!-- Fixer Stundenplan Thumbnail + Modal (ausklappbar) --><div class="fixed-thumb" id="fixedThumb" title="Fixen Stundenplan vergrößern">
  <div class="label">Stundenplan</div>
  <div class="hint">Tippen zum Vergrößern</div>
</div>
<div class="modal" id="fixedModal">
  <div class="dialog">
    <div class="close-x" id="closeModal">Schließen ✕</div>
    <h3>Fixer Stundenplan (Schuljahr)</h3>
    <div class="iframe-wrap" style="padding:8px">
      <table>
        <thead><tr><th>Zeit</th><th>Mo</th><th>Di</th><th>Mi</th><th>Do</th><th>Fr</th></tr></thead>
        <tbody id="stundenplan-fix"></tbody>
      </table>
    </div>
  </div>
</div><!-- Kalender-Bubble (Monatsansicht) unter Stundenplan --><div class="fixed-thumb" id="monthThumb" title="Monatskalender öffnen">
  <div class="label">Kalender</div>
  <div class="hint">Monatsansicht</div>
</div>
<div class="modal" id="monthModal">
  <div class="dialog">
    <div class="close-x" id="closeMonth">Schließen ✕</div>
    <h3>Alle Kalender · Monatsansicht</h3>
    <div class="iframe-wrap" style="padding:0">
      <iframe id="monthFrame" height="600"></iframe>
    </div>
    <div class="note">Für Google-Embeds muss der eingeloggte Account Zugriffsrechte haben – sonst „Berechtigung erforderlich“.</div>
  </div>
</div><!-- Diagnose Badge --><div class="diag" id="diag">Init…</div><script>
/* ================== KONFIG ================== */
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyw8-Ns-eaFBpr_aMXYxx8RNujRoZ3X89Txu61Zqf9N_TiO1xGviCLB9hqtKnYUeBdk/exec';
const CAL = {
  VALENTIN:'057e175cb88528446a3b90c6e6ff1124f870e0d6b97ded0da00e1fce8e509188@group.calendar.google.com',
  GENERAL:'gabstaschill@gmail.com',
  DIENST:'emujcvc9sc89j8gi2l9kdvf1i0@group.calendar.google.com'
};

/* Apps öffnen: zuerst Fully JS (wenn verfügbar), sonst intent:// Fallback */
const APPS = [
  { title:'Philips Hue',   pkg:'com.philips.lighting.hue2', intent:'intent://com.philips.lighting.hue2/#Intent;scheme=app;package=com.philips.lighting.hue2;end', label:'Hue App öffnen' },
  { title:'Sonos',         pkg:'com.sonos.acr2',            intent:'intent://com.sonos.acr2/#Intent;scheme=app;package=com.sonos.acr2;end',            label:'Sonos App öffnen' },
  { title:'tado°',         pkg:'com.tado',                  intent:'intent://com.tado/#Intent;scheme=app;package=com.tado;end',                         label:'tado° App öffnen' },
  { title:'eufy Security', pkg:'com.oceanwing.battery.cam', intent:'intent://com.oceanwing.battery.cam/#Intent;scheme=app;package=com.oceanwing.battery.cam;end', label:'eufy App öffnen' }
];

/* ================== Helpers ================== */
const $ = s => document.querySelector(s);
function setDiag(msg){ const d=$('#diag'); if(d) d.textContent = msg; }
window.addEventListener('error', (e)=>{ setDiag('JS-Fehler: '+ (e.message||'unbekannt')); });
function toTimeStr(d){ return new Date(d).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'}); }
function ymd(d){ return d.getFullYear()+String(d.getMonth()+1).padStart(2,'0')+String(d.getDate()).padStart(2,'0'); }
function isoDate(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function dayKey(d){ return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; }
function buildGoogleEmbed(params){
  const base='https://calendar.google.com/calendar/embed?';
  const common=['ctz=Europe/Berlin','showTitle=0','showPrint=0','showCalendars=0','showTz=0','wkst=2'];
  return base+[...common,...params].join('&');
}

/* ================== Heute/Morgen (Valentin) ================== */
async function loadDayEvents(listEl,statusEl,fallbackBox,fallbackIframe,calId,iso,ymdStr){
  try{
    statusEl.textContent='Lade Termine…';
    const res=await fetch(`${APPS_SCRIPT_URL}?cal=${encodeURIComponent(calId)}&from=${iso}T00:00:00&to=${iso}T23:59:59`);
    if(!res.ok) throw new Error(res.status);
    const data=await res.json(); listEl.innerHTML='';
    if(Array.isArray(data) && data.length){
      data.sort((a,b)=>new Date(a.start)-new Date(b.start));
      data.forEach(ev=>{
        const li=document.createElement('li');
        const t=ev.allDay?'Ganztägig':`${toTimeStr(ev.start)}–${toTimeStr(ev.end)}`;
        li.textContent=`${t} · ${ev.summary||''}`; listEl.appendChild(li);
      });
      statusEl.textContent=''; if(fallbackBox) fallbackBox.style.display='none';
    } else {
      statusEl.textContent='Keine Termine.';
      if(fallbackBox && fallbackIframe){ fallbackIframe.src = googleAgendaDay(calId, ymdStr); fallbackBox.style.display='block'; }
    }
  }catch(e){
    statusEl.textContent='Fehler beim Laden.';
    if(fallbackBox && fallbackIframe){ fallbackIframe.src = googleAgendaDay(calId, ymdStr); fallbackBox.style.display='block'; }
  }
}

function googleAgendaDay(calId, ymdStr){
  const y=+ymdStr.slice(0,4), m=+ymdStr.slice(4,6)-1, d=+ymdStr.slice(6,8);
  const start=new Date(y,m,d); const end=new Date(start); end.setDate(start.getDate()+1);
  const endYMD = ymd(end);
  return buildGoogleEmbed(['mode=AGENDA', `dates=${ymdStr}/${endYMD}`, 'src='+encodeURIComponent(calId)]);
}

/* ================== Kombinierte 7-Tage-Agenda (Apps Script) ================== */
async function loadCombinedAgenda(){
  const status = $('#combined-status');
  const list   = $('#combined-agenda');
  const errors = $('#combined-errors');
  status.textContent = 'Lade Agenda…'; list.innerHTML = ''; errors.innerHTML='';

  const start = new Date(); start.setHours(0,0,0,0);
  const end   = new Date(start); end.setDate(end.getDate()+7); end.setHours(23,59,59,999);

  const CALS = [
    {id:CAL.GENERAL,  label:'Allgemein'},
    {id:CAL.DIENST,   label:'Dienstplan'},
    {id:CAL.VALENTIN, label:'Valentin'}
  ];
  const all = [];
  for (const c of CALS){
    try{
      const res = await fetch(`${APPS_SCRIPT_URL}?cal=${encodeURIComponent(c.id)}&from=${isoDate(start)}T00:00:00&to=${isoDate(end)}T23:59:59`);
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      if(Array.isArray(data)) data.forEach(e => all.push({...e, _cal: c.label}));
    }catch(err){
      const p=document.createElement('div'); p.className='error';
      p.textContent = `⚠️ Kein Zugriff auf Kalender „${c.label}“ (prüfe Freigabe/Deploy/CORS).`;
      errors.appendChild(p);
    }
  }

  // Gruppieren nach Datum
  const byDay = {};
  for(let i=0;i<8;i++){ const d = new Date(start); d.setDate(start.getDate()+i); byDay[dayKey(d)] = { date: new Date(d), items: [] }; }
  all.forEach(ev=>{
    const d = new Date(ev.start);
    const key = dayKey(new Date(d.getFullYear(), d.getMonth(), d.getDate()));
    if(byDay[key]) byDay[key].items.push(ev);
  });

  const dayNames = ['So','Mo','Di','Mi','Do','Fr','Sa'];
  Object.values(byDay).sort((a,b)=>a.date-b.date).forEach(group=>{
    const h = document.createElement('li'); h.className='agenda-day';
    const label = `${dayNames[group.date.getDay()]} ${group.date.toLocaleDateString('de-DE')}`;
    h.innerHTML = `<h4>${label}</h4>`;
    if(group.items.length===0){
      const li = document.createElement('div'); li.className='agenda-item muted'; li.textContent='—'; h.appendChild(li);
    }else{
      group.items.sort((a,b)=>new Date(a.start)-new Date(b.start));
      group.items.forEach(ev=>{
        const li = document.createElement('div'); li.className='agenda-item';
        const t = ev.allDay ? 'Ganztägig' : `${toTimeStr(ev.start)}–${toTimeStr(ev.end)}`;
        li.textContent = `${t} · ${ev.summary||'(ohne Titel)'} (${ev._cal})`;
        h.appendChild(li);
      });
    }
    list.appendChild(h);
  });

  status.textContent = '';
}

/* ================== Fixed Stundenplan (Demo) ================== */
const fixedData=[
  {time:'08:00–08:45', mo:'Mathe', moCls:'fach-mathe', di:'Deutsch', diCls:'fach-deutsch', mi:'Englisch', miCls:'fach-englisch', do:'Mathe', doCls:'fach-mathe', fr:'Musik', frCls:'fach-musik'},
  {time:'09:00–09:45', mo:'Englisch', moCls:'fach-englisch', di:'Musik', diCls:'fach-musik', mi:'Deutsch', miCls:'fach-deutsch', do:'Kunst', doCls:'fach-kunst', fr:'Mathe', frCls:'fach-mathe'}
];
function row(r){return `<tr><td>${r.time}</td><td class="${r.moCls}">${r.mo}</td><td class="${r.diCls}">${r.di}</td><td class="${r.miCls}">${r.mi}</td><td class="${r.doCls}">${r.do}</td><td class="${r.frCls}">${r.fr}</td></tr>`}

/* ================== Smart Home ================== */
function renderSmartHome(){
  try{
    const widgets=$('#widgets');
    if(!widgets){ setDiag('Fehler: #widgets fehlt'); return; }
    APPS.forEach(app=>{
      const div=document.createElement('div'); div.className='tile';
      div.innerHTML=`<h4>${app.title}</h4>`; const row=document.createElement('div'); row.className='btnrow';
      const btn=document.createElement('a'); btn.className='btn'; btn.textContent=app.label; btn.href=app.intent; btn.target='_self'; btn.rel='noopener';
      btn.addEventListener('click', (ev)=>{
        try{
          if(window.fully && typeof fully.startApplication==='function'){
            fully.startApplication(app.pkg); ev.preventDefault();
          }
        }catch(e){ /* fallback to intent */ }
      });
      row.appendChild(btn); div.appendChild(row); widgets.appendChild(div);
    });
  }catch(e){ setDiag('renderSmartHome() Fehler'); }
}

/* ================== Monatskalender (Popup) ================== */
function buildMonthEmbed(){
  const srcs = [CAL.GENERAL, CAL.DIENST, CAL.VALENTIN].map(id=>'src='+encodeURIComponent(id));
  return buildGoogleEmbed(['mode=MONTH', ...srcs]);
}
function wireMonthModal(){
  try{
    const modal=$('#monthModal'); const thumb=$('#monthThumb'); const close=$('#closeMonth'); const frame=$('#monthFrame');
    if(!modal||!thumb||!close||!frame){ setDiag('monthModal Elemente fehlen'); return; }
    function toggle(){ modal.classList.toggle('open'); if(modal.classList.contains('open')) frame.src = buildMonthEmbed(); }
    thumb.addEventListener('click', toggle); close.addEventListener('click', toggle); modal.addEventListener('click', e=>{ if(e.target===modal) toggle(); });
  }catch(e){ setDiag('wireMonthModal() Fehler'); }
}

/* ================== Stundenpläne (Demo) ================== */
function renderStundenplaene(){
  try{
    const stHeute=$('#stundenplan-heute'); const stMorgen=$('#stundenplan-morgen'); const fixBody=$('#stundenplan-fix');
    if(!stHeute||!stMorgen||!fixBody){ setDiag('Stundenplan-Elemente fehlen'); return; }
    stHeute.innerHTML=`<tr><td>08:00–08:45</td><td class="fach-mathe">Mathematik</td><td>101</td></tr>
    <tr><td>09:00–09:45</td><td class="fach-englisch">Englisch</td><td>204</td></tr>
    <tr><td>10:00–10:45</td><td class="fach-deutsch">Deutsch</td><td>112</td></tr>`;
    stMorgen.innerHTML=`<tr><td>08:00–08:45</td><td class="fach-deutsch">Deutsch</td><td>101</td></tr>
    <tr><td>09:00–09:45</td><td class="fach-mathe">Mathematik</td><td>204</td></tr>
    <tr><td>10:00–10:45</td><td class="fach-musik">Musik</td><td>Saal</td></tr>`;
    fixBody.innerHTML=fixedData.map(row).join('');
  }catch(e){ setDiag('renderStundenplaene() Fehler'); }
}

/* ================== Heute/Morgen Refresh ================== */
function refreshTodayTomorrow(){
  try{
    const now = new Date(); const TODAY_ISO = isoDate(now), TODAY_YMD = ymd(now);
    const tmr = new Date(now); tmr.setDate(now.getDate()+1); const TOMORROW_ISO = isoDate(tmr), TOMORROW_YMD = ymd(tmr);
    const todayBox=$('#valentin-today-fallback'); const todayIframe=$('#valentin-today');
    if(todayIframe){ todayIframe.src = googleAgendaDay(CAL.VALENTIN, TODAY_YMD); if(todayBox) todayBox.style.display='block'; }
    loadDayEvents($('#valentin-today-list'), $('#valentin-today-status'), todayBox, todayIframe, CAL.VALENTIN, TODAY_ISO, TODAY_YMD);
    loadDayEvents($('#valentin-tomorrow-list'), $('#valentin-tomorrow-status'), null, null, CAL.VALENTIN, TOMORROW_ISO, TOMORROW_YMD);
  }catch(e){ setDiag('refreshTodayTomorrow() Fehler'); }
}

/* ================== Stundenplan-Modal ================== */
function wireFixedModal(){
  try{
    const modal=$('#fixedModal'); const thumb=$('#fixedThumb'); const closeBtn=$('#closeModal');
    if(!modal||!thumb||!closeBtn){ setDiag('fixedModal Elemente fehlen'); return; }
    const toggle=()=> modal.classList.toggle('open');
    thumb.addEventListener('click', toggle); closeBtn.addEventListener('click', toggle); modal.addEventListener('click', e=>{ if(e.target===modal) toggle(); });
  }catch(e){ setDiag('wireFixedModal() Fehler'); }
}

/* ================== INIT ================== */
(function init(){
  try{
    setDiag('Init…');
    renderSmartHome(); setDiag('SmartHome OK');
    renderStundenplaene(); setDiag('Stundenpläne OK');
    wireFixedModal(); setDiag('Stundenplan-Modal OK');
    wireMonthModal(); setDiag('Monatskalender-Modal OK');
    refreshTodayTomorrow(); setDiag('Heute/Morgen OK');
    loadCombinedAgenda(); setDiag('Agenda OK');
  }catch(e){ setDiag('Init Fehler: '+e.message); }
})();

// Auto-Reload alle 5 Minuten
setInterval(()=>{ try{ refreshTodayTomorrow(); loadCombinedAgenda(); setDiag('Auto-Reload OK'); }catch(e){ setDiag('Auto-Reload Fehler'); } }, 5*60*1000);
</script></body>
</html>
