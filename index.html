<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Familien- & Wochenplaner</title>
  <style>
    :root{ --bg:#f5f6fa; --card:#ffffff; --primary:#3949ab; --radius:18px; }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0; background:var(--bg); font-family:system-ui,Arial,sans-serif; color:#222; display:flex; flex-direction:column }
    header{ background:var(--primary); color:#fff; padding:10px 16px; text-align:center; font-weight:600; letter-spacing:.2px }
    .wrap{ padding:12px; display:grid; gap:12px }
    .card{ background:var(--card); border-radius:var(--radius); box-shadow:0 4px 16px rgba(0,0,0,.08); padding:10px }
    .card h3{ margin:0 0 8px 6px; font-size:15px; color:#333 }

    .top-grid{ display:grid; gap:12px; grid-template-columns: 1fr 1fr; align-items:stretch }
    @media (max-width:900px){ .top-grid{ grid-template-columns:1fr } }

    table{ border-collapse:collapse; width:100% }
    th,td{ padding:6px; border:1px solid #e5e5e5; text-align:center; font-size:13px }
    thead tr{ background:#e8eaf6 }
    .fach-mathe{ background:#bbdefb } .fach-deutsch{ background:#c8e6c9 }
    .fach-englisch{ background:#ffe0b2 } .fach-sport{ background:#ffccbc } .fach-kunst{ background:#f8bbd0 }

    .iframe-wrap{ border:1px solid #eee; border-radius:10px; overflow:hidden }
    iframe{ display:block; width:100%; border:0 }
  </style>
</head>
<body>
<header>ðŸ“… Familien- & Wochenplaner</header>
<div class="wrap">

  <!-- OBERER BEREICH -->
  <div class="top-grid">
    <!-- HEUTE â€“ Valentin -->
    <section class="card">
      <h3>Heute Â· Valentin â€“ Stundenplan & Termine</h3>
      <div style="display:grid;gap:6px;grid-template-rows:auto auto">
        <!-- Stundenplan HEUTE -->
        <div class="iframe-wrap" style="padding:6px">
          <table>
            <thead><tr><th>Zeit</th><th>Fach</th><th>Raum</th></tr></thead>
            <tbody id="stundenplan-heute"></tbody>
          </table>
        </div>
        <!-- Termine HEUTE -->
        <div class="iframe-wrap" style="padding:6px">
          <div style="font-weight:600;margin:2px 0 6px 0">Termine Â· Heute</div>
          <ul id="valentin-today-list" style="list-style:none;margin:0;padding:0"></ul>
          <div id="valentin-today-status" style="margin-top:6px;color:#666;font-size:12px"></div>
          <div id="valentin-today-fallback" style="display:none;margin-top:6px">
            <iframe id="valentin-today" height="200" loading="lazy"></iframe>
          </div>
        </div>
      </div>
    </section>

    <!-- MORGEN â€“ Valentin (nur Liste, kein Fallback-Iframe) -->
    <section class="card">
      <h3>Morgen Â· Valentin â€“ Stundenplan & Termine</h3>
      <div style="display:grid;gap:6px;grid-template-rows:auto auto">
        <!-- Stundenplan MORGEN -->
        <div class="iframe-wrap" style="padding:6px">
          <table>
            <thead><tr><th>Zeit</th><th>Fach</th><th>Raum</th></tr></thead>
            <tbody id="stundenplan-morgen"></tbody>
          </table>
        </div>
        <!-- Termine MORGEN (nur gefilterte Liste) -->
        <div class="iframe-wrap" style="padding:6px">
          <div style="font-weight:600;margin:2px 0 6px 0">Termine Â· Morgen</div>
          <ul id="valentin-tomorrow-list" style="list-style:none;margin:0;padding:0"></ul>
          <div id="valentin-tomorrow-status" style="margin-top:6px;color:#666;font-size:12px"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- FIXER STUNDENPLAN -->
  <section class="card">
    <h3>Fixer Stundenplan (Schuljahr)</h3>
    <div style="overflow:auto">
      <table>
        <thead><tr><th>Zeit</th><th>Mo</th><th>Di</th><th>Mi</th><th>Do</th><th>Fr</th></tr></thead>
        <tbody id="stundenplan-fix"><!-- hier spÃ¤ter echte Daten eintragen --></tbody>
      </table>
    </div>
  </section>

  <!-- ZUSAMMENGEFASSTE WOCHE -->
  <section class="card">
    <h3>Woche Â· Dienstplan + Sonstige Termine + Geburtstage + Valentin</h3>
    <div class="iframe-wrap"><iframe id="combined-week" height="300" loading="lazy"></iframe></div>
  </section>

</div>

<script>
  // Apps Script Web-App (liefert JSON-Events)
  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyw8-Ns-eaFBpr_aMXYxx8RNujRoZ3X89Txu61Zqf9N_TiO1xGviCLB9hqtKnYUeBdk/exec';

  // Kalender-IDs
  const CAL = {
    VALENTIN: '057e175cb88528446a3b90c6e6ff1124f870e0d6b97ded0da00e1fce8e509188@group.calendar.google.com',
    GENERAL:  'gabstaschill@gmail.com',
    DIENST:   'emujcvc9sc89j8gi2l9kdvf1i0@group.calendar.google.com',
    BDAY:     'addressbook#contacts@group.v.calendar.google.com'
  };

  // Helpers
  function toTimeStr(d){ return new Date(d).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'}); }
  function buildBase(params){
    const base='https://calendar.google.com/calendar/embed?';
    const common=['ctz=Europe/Berlin','showTitle=0','showPrint=0','showCalendars=0','showTz=0','wkst=2'];
    return base + [...common, ...params].join('&');
  }
  function urlWeek(calIds){
    const srcs = calIds.map(id=>`src=${encodeURIComponent(id)}`);
    return buildBase(['mode=WEEK', ...srcs]);
  }
  function urlAgendaDay(calIds, ymd){
    // Intervall: [Tag, Folgetag) â€“ damit Google-Embed wirklich nur den einen Tag zeigt
    const year = +ymd.slice(0,4), month = +ymd.slice(4,6)-1, day = +ymd.slice(6,8);
    const start = new Date(year, month, day);
    const end = new Date(start); end.setDate(start.getDate()+1);
    const endYMD = `${end.getFullYear()}${String(end.getMonth()+1).padStart(2,'0')}${String(end.getDate()).padStart(2,'0')}`;
    const srcs = calIds.map(id=>`src=${encodeURIComponent(id)}`);
    return buildBase(['mode=AGENDA', `dates=${ymd}/${endYMD}`, ...srcs]);
  }
  function computeDates(){
    const now = new Date();
    const y = now.getFullYear(), m = String(now.getMonth()+1).padStart(2,'0'), d = String(now.getDate()).padStart(2,'0');
    const TODAY_ISO = `${y}-${m}-${d}`, TODAY_YMD = `${y}${m}${d}`;
    const tmr = new Date(now); tmr.setDate(now.getDate()+1);
    const ty = tmr.getFullYear(), tm = String(tmr.getMonth()+1).padStart(2,'0'), td = String(tmr.getDate()).padStart(2,'0');
    const TOMORROW_ISO = `${ty}-${tm}-${td}`, TOMORROW_YMD = `${ty}${tm}${td}`;
    return { TODAY_ISO, TODAY_YMD, TOMORROW_ISO, TOMORROW_YMD };
  }

  // Stundenplan (Demo â€“ ersetze spÃ¤ter)
  const stHeute = document.getElementById('stundenplan-heute');
  const stMorgen = document.getElementById('stundenplan-morgen');
  const demoToday = [
    {time:'08:00â€“08:45',subject:'Mathe',room:'101',cls:'fach-mathe'},
    {time:'09:00â€“09:45',subject:'Englisch',room:'204',cls:'fach-englisch'},
    {time:'10:00â€“10:45',subject:'Deutsch',room:'112',cls:'fach-deutsch'}
  ];
  const demoTomorrow = [
    {time:'08:00â€“08:45',subject:'Deutsch',room:'101',cls:'fach-deutsch'},
    {time:'09:00â€“09:45',subject:'Mathe',room:'204',cls:'fach-mathe'},
    {time:'10:00â€“10:45',subject:'Sport',room:'Halle',cls:'fach-sport'}
  ];
  stHeute.innerHTML  = demoToday.map(l=>`<tr><td>${l.time}</td><td class="${l.cls}">${l.subject}</td><td>${l.room}</td></tr>`).join('');
  stMorgen.innerHTML = demoTomorrow.map(l=>`<tr><td>${l.time}</td><td class="${l.cls}">${l.subject}</td><td>${l.room}</td></tr>`).join('');

  // Tages-Events via Apps Script (mit optionalem Fallback auf Tages-Iframe)
  async function loadDayEvents(listEl, statusEl, fallbackBoxEl, fallbackIframeEl, calendarId, dayISO, dayYMD){
    try{
      statusEl.textContent = 'Lade Termineâ€¦';
      const url = `${APPS_SCRIPT_URL}?cal=${encodeURIComponent(calendarId)}&from=${dayISO}T00:00:00&to=${dayISO}T23:59:59`;
      const res = await fetch(url);
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      listEl.innerHTML = '';
      if(Array.isArray(data) && data.length){
        data.sort((a,b)=>new Date(a.start)-new Date(b.start));
        data.forEach(ev => {
          const li = document.createElement('li');
          li.style.padding = '4px 0';
          const time = (ev.allDay? 'GanztÃ¤gig' : `${toTimeStr(ev.start)}â€“${toTimeStr(ev.end)}`);
          li.innerHTML = `<div style=\"font-weight:600\">${time} Â· ${ev.summary||'(ohne Titel)'}<\/div>${ev.location?`<div style=\"font-size:12px;color:#666\">${ev.location}<\/div>`:''}`;
          listEl.appendChild(li);
        });
        statusEl.textContent = '';
        if(fallbackBoxEl) fallbackBoxEl.style.display = 'none';
      } else {
        statusEl.textContent = '';
        if(fallbackBoxEl && fallbackIframeEl){
          fallbackIframeEl.src = urlAgendaDay([calendarId], dayYMD);
          fallbackBoxEl.style.display = 'block';
        }
      }
    }catch(err){
      statusEl.textContent = '';
      if(fallbackBoxEl && fallbackIframeEl){
        fallbackIframeEl.src = urlAgendaDay([calendarId], dayYMD);
        fallbackBoxEl.style.display = 'block';
      }
    }
  }

  function refreshAll(){
    const d = computeDates();

    // HEUTE: Fallback-Iframe vorab setzen (damit immer etwas sichtbar ist)
    const todayBox = document.getElementById('valentin-today-fallback');
    const todayIframe = document.getElementById('valentin-today');
    if(todayIframe){ todayIframe.src = urlAgendaDay([CAL.VALENTIN], d.TODAY_YMD); todayBox.style.display='block'; }

    // Listen laden (MORGEN ohne Fallback â†’ garantiert nur Liste)
    loadDayEvents(
      document.getElementById('valentin-today-list'),
      document.getElementById('valentin-today-status'),
      todayBox, todayIframe,
      CAL.VALENTIN,
      d.TODAY_ISO,
      d.TODAY_YMD
    );
    loadDayEvents(
      document.getElementById('valentin-tomorrow-list'),
      document.getElementById('valentin-tomorrow-status'),
      null, null,
      CAL.VALENTIN,
      d.TOMORROW_ISO,
      d.TOMORROW_YMD
    );

    // Kombinierte Woche neu setzen (mit leichtem Cache-Busting)
    const week = document.getElementById('combined-week');
    week.src = urlWeek([CAL.GENERAL, CAL.DIENST, CAL.BDAY, CAL.VALENTIN]) + `&v=${Date.now()}`;
  }

  // Initial + Auto-Reload alle 5 Minuten
  refreshAll();
  setInterval(refreshAll, 5 * 60 * 1000);
</script>
</body>
</html>
