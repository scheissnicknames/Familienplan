<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Familien- & Wochenplaner</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a; --card:#0b1226; --card-2:#101a33;
      --text:#e5e7eb; --primary:#7c3aed; --accent:#06b6d4;
      --rot:#ef4444; --blau:#3b82f6; --gelb:#facc15;
      --gruen:#22c55e; --orange:#fb923c; --braun:#8b5e34;
    }
    body{margin:0;background:var(--bg);font-family:'Inter',sans-serif;color:var(--text)}
    header{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;padding:14px;text-align:center;font-weight:800}
    .wrap{padding:14px;display:grid;gap:14px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
          border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:12px}
    .card h3{margin:0 0 10px;font-size:16px}
    .top-grid{display:grid;gap:14px;grid-template-columns:1fr 1fr}
    @media(max-width:900px){.top-grid{grid-template-columns:1fr}}
    table{border-collapse:separate;border-spacing:0;width:100%;border-radius:12px;overflow:hidden}
    th,td{padding:8px;border:1px solid rgba(255,255,255,.08);text-align:center;font-size:13px}
    thead tr{background:rgba(255,255,255,.05)}
    /* Fachfarben */
    .fach-mathe{background:var(--rot);color:#fff}
    .fach-deutsch{background:var(--blau);color:#fff}
    .fach-englisch{background:var(--gelb);color:#111}
    .fach-musik{background:var(--gruen);color:#fff}
    .fach-kunst{background:var(--blau);color:#fff}
    .fach-sachkunde{background:var(--orange);color:#111}
    /* MÃ¼ll */
    .muell-gelber{background:var(--gelb);color:#111}
    .muell-rest{background:var(--gruen);color:#fff}
    .muell-papier{background:var(--blau);color:#fff}
    .muell-laub{background:var(--braun);color:#fff}
    .iframe-wrap{border:1px solid rgba(255,255,255,.08);border-radius:12px;background:var(--card-2);overflow:hidden}
    iframe{width:100%;border:0}
    .legend{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .legend span{padding:4px 8px;border-radius:999px;font-size:11px;color:#fff}
    /* Widgets */
    .widgets{display:grid;gap:12px;grid-template-columns:repeat(4,1fr)}
    @media(max-width:1200px){.widgets{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:700px){.widgets{grid-template-columns:1fr}}
    .tile{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);
          border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:8px}
    .tile h4{margin:0;font-size:14px}
    .btnrow{display:flex;flex-wrap:wrap;gap:8px}
    .btn{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);
         padding:8px 10px;border-radius:12px;font-size:13px;font-weight:600;color:#fff;cursor:pointer}
  </style>
</head>
<body>
<header>ðŸ“… Familien- & Wochenplaner</header>
<div class="wrap">

  <!-- Heute/Morgen -->
  <div class="top-grid">
    <section class="card">
      <h3>Heute Â· Valentin</h3>
      <div class="iframe-wrap" style="padding:6px">
        <table><thead><tr><th>Zeit</th><th>Fach</th><th>Raum</th></tr></thead>
        <tbody id="stundenplan-heute"></tbody></table>
      </div>
      <div class="iframe-wrap" style="padding:10px">
        <strong>Termine Â· Heute</strong>
        <ul id="valentin-today-list" style="list-style:none;padding:0"></ul>
        <div id="valentin-today-status" style="font-size:12px"></div>
        <div id="valentin-today-fallback" style="display:none"><iframe id="valentin-today" height="200"></iframe></div>
      </div>
    </section>

    <section class="card">
      <h3>Morgen Â· Valentin</h3>
      <div class="iframe-wrap" style="padding:6px">
        <table><thead><tr><th>Zeit</th><th>Fach</th><th>Raum</th></tr></thead>
        <tbody id="stundenplan-morgen"></tbody></table>
      </div>
      <div class="iframe-wrap" style="padding:10px">
        <strong>Termine Â· Morgen</strong>
        <ul id="valentin-tomorrow-list" style="list-style:none;padding:0"></ul>
        <div id="valentin-tomorrow-status" style="font-size:12px"></div>
      </div>
    </section>
  </div>

  <!-- Fixer Stundenplan + MÃ¼ll -->
  <section class="card">
    <h3>Fixer Stundenplan</h3>
    <div class="iframe-wrap" style="padding:6px">
      <table>
        <thead><tr><th>Zeit</th><th>Mo</th><th>Di</th><th>Mi</th><th>Do</th><th>Fr</th></tr></thead>
        <tbody id="stundenplan-fix"></tbody>
      </table>
    </div>
    <div class="legend">
      <span class="muell-gelber">Gelber Sack</span>
      <span class="muell-rest">RestmÃ¼ll</span>
      <span class="muell-papier">Papier</span>
      <span class="muell-laub">LaubsÃ¤cke</span>
    </div>
  </section>

  <!-- Woche -->
  <section class="card">
    <h3>Woche Â· alle Kalender</h3>
    <div class="iframe-wrap"><iframe id="combined-week" height="300"></iframe></div>
  </section>

  <!-- Smart Home Widgets -->
  <section class="card">
    <h3>Smart Home</h3>
    <div class="widgets" id="widgets"></div>
  </section>

</div>

<script>
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyw8-Ns-eaFBpr_aMXYxx8RNujRoZ3X89Txu61Zqf9N_TiO1xGviCLB9hqtKnYUeBdk/exec';
const CAL = {
  VALENTIN:'057e175cb88528446a3b90c6e6ff1124f870e0d6b97ded0da00e1fce8e509188@group.calendar.google.com',
  GENERAL:'gabstaschill@gmail.com',
  DIENST:'emujcvc9sc89j8gi2l9kdvf1i0@group.calendar.google.com',
  BDAY:'addressbook#contacts@group.v.calendar.google.com'
};

function buildBase(params){
  const base='https://calendar.google.com/calendar/embed?';
  const common=['ctz=Europe/Berlin','showTitle=0','showPrint=0','showCalendars=0','showTz=0','wkst=2'];
  return base+[...common,...params].join('&');
}
function urlWeek(ids){return buildBase(['mode=WEEK',...ids.map(i=>'src='+encodeURIComponent(i))]);}
function urlAgendaDay(id,ymd){
  const y=+ymd.slice(0,4),m=+ymd.slice(4,6)-1,d=+ymd.slice(6,8);
  const start=new Date(y,m,d);const end=new Date(start);end.setDate(start.getDate()+1);
  const endYMD=`${end.getFullYear()}${String(end.getMonth()+1).padStart(2,'0')}${String(end.getDate()).padStart(2,'0')}`;
  return buildBase(['mode=AGENDA',`dates=${ymd}/${endYMD}`,'src='+encodeURIComponent(id)]);
}
function computeDates(){
  const now=new Date(), y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,'0'), d=String(now.getDate()).padStart(2,'0');
  const TODAY_ISO=`${y}-${m}-${d}`, TODAY_YMD=`${y}${m}${d}`;
  const t=new Date(now);t.setDate(now.getDate()+1);
  const TOMORROW_ISO=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
  const TOMORROW_YMD=`${t.getFullYear()}${String(t.getMonth()+1).padStart(2,'0')}${String(t.getDate()).padStart(2,'0')}`;
  return {TODAY_ISO,TODAY_YMD,TOMORROW_ISO,TOMORROW_YMD};
}
function toTimeStr(d){return new Date(d).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});}

async function loadDayEvents(listEl,statusEl,fallbackBox,fallbackIframe,calId,iso,ymd){
  try{
    statusEl.textContent='Lade Termineâ€¦';
    const res=await fetch(`${APPS_SCRIPT_URL}?cal=${encodeURIComponent(calId)}&from=${iso}T00:00:00&to=${iso}T23:59:59`);
    if(!res.ok) throw new Error(res.status);
    const data=await res.json();listEl.innerHTML='';
    if(data.length){data.sort((a,b)=>new Date(a.start)-new Date(b.start));
      data.forEach(ev=>{
        const li=document.createElement('li');
        const t=ev.allDay?'GanztÃ¤gig':`${toTimeStr(ev.start)}â€“${toTimeStr(ev.end)}`;
        li.innerHTML=`${t} Â· ${ev.summary||''}`;listEl.appendChild(li);
      });statusEl.textContent='';if(fallbackBox) fallbackBox.style.display='none';
    }else{statusEl.textContent='Keine Termine';if(fallbackBox&&fallbackIframe){fallbackIframe.src=urlAgendaDay(calId,ymd);fallbackBox.style.display='block';}}
  }catch(e){statusEl.textContent='Fehler';if(fallbackBox&&fallbackIframe){fallbackIframe.src=urlAgendaDay(calId,ymd);fallbackBox.style.display='block';}}
}

function refreshAll(){
  const d=computeDates();
  const todayBox=document.getElementById('valentin-today-fallback');
  const todayIframe=document.getElementById('valentin-today');
  if(todayIframe){todayIframe.src=urlAgendaDay(CAL.VALENTIN,d.TODAY_YMD);todayBox.style.display='block';}
  loadDayEvents(document.getElementById('valentin-today-list'),document.getElementById('valentin-today-status'),todayBox,todayIframe,CAL.VALENTIN,d.TODAY_ISO,d.TODAY_YMD);
  loadDayEvents(document.getElementById('valentin-tomorrow-list'),document.getElementById('valentin-tomorrow-status'),null,null,CAL.VALENTIN,d.TOMORROW_ISO,d.TOMORROW_YMD);
  document.getElementById('combined-week').src=urlWeek([CAL.GENERAL,CAL.DIENST,CAL.BDAY,CAL.VALENTIN])+`&v=${Date.now()}`;
}

// Demo StundenplÃ¤ne
const stHeute=document.getElementById('stundenplan-heute');
stHeute.innerHTML=`<tr><td>08:00â€“08:45</td><td class=\"fach-mathe\">Mathe</td><td>101</td></tr>
<tr><td>09:00â€“09:45</td><td class=\"fach-englisch\">Englisch</td><td>204</td></tr>
<tr><td>10:00â€“10:45</td><td class=\"fach-deutsch\">Deutsch</td><td>112</td></tr>`;
const stMorgen=document.getElementById('stundenplan-morgen');
stMorgen.innerHTML=`<tr><td>08:00â€“08:45</td><td class=\"fach-deutsch\">Deutsch</td><td>101</td></tr>
<tr><td>09:00â€“09:45</td><td class=\"fach-mathe\">Mathe</td><td>204</td></tr>
<tr><td>10:00â€“10:45</td><td class=\"fach-musik\">Musik</td><td>Saal</td></tr>`;

refreshAll();setInterval(refreshAll,5*60*1000);

// Smart Home Widgets
const widgets=document.getElementById('widgets');
const ACTIONS=[{title:'Philips Hue',items:[{label:'Abendlicht'},{label:'Alles aus'}]},
               {title:'Sonos',items:[{label:'Play'},{label:'Pause'}]},
               {title:'tadoÂ°',items:[{label:'Komfort'},{label:'Eco'}]},
               {title:'eufy',items:[{label:'TÃ¼rklingel'},{label:'Garten'}]}];
ACTIONS.forEach(gr=>{const div=document.createElement('div');div.className='tile';
  div.innerHTML=`<h4>${gr.title}</h4>`;const row=document.createElement('div');row.className='btnrow';
  gr.items.forEach(it=>{const b=document.createElement('button');b.className='btn';b.textContent=it.label;row.appendChild(b);});
  div.appendChild(row);widgets.appendChild(div);});
</script>
</body>
</html>
