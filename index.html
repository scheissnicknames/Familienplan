<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Familien- & Wochenplaner</title>
  <style>
    :root{
      --bg:#f5f6fa; --card:#ffffff; --primary:#3949ab; --muted:#e8eaf6; --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);font-family:system-ui,Arial,sans-serif;color:#222;display:flex;flex-direction:column}
    header{background:var(--primary);color:#fff;padding:10px 16px;text-align:center;font-weight:600;letter-spacing:.2px}
    .wrap{padding:12px;display:grid;gap:12px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 4px 16px rgba(0,0,0,.08);padding:10px}
    .card h3{margin:0 0 8px 6px;font-size:15px;color:#333}

    /* Grids */
    .top-grid{display:grid;gap:12px;grid-template-columns: 1fr 1fr;align-items:stretch}
    .mid-grid,.bottom-grid{display:grid;gap:12px;grid-template-columns: 1fr}

    /* Tabellen */
    table{border-collapse:collapse;width:100%}
    th,td{padding:6px;border:1px solid #e5e5e5;text-align:center;font-size:13px}
    thead tr{background:#e8eaf6}
    .fach-mathe{background:#bbdefb}
    .fach-deutsch{background:#c8e6c9}
    .fach-englisch{background:#ffe0b2}
    .fach-sport{background:#ffccbc}
    .fach-kunst{background:#f8bbd0}

    /* Iframe wrappers */
    .iframe-wrap{border:1px solid #eee;border-radius:10px;overflow:hidden}
    iframe{display:block;width:100%;border:0}

    @media (max-width:900px){.top-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header>ðŸ“… Familien- & Wochenplaner</header>
<div class="wrap">

  <!-- ===== OBERER BEREICH ===== -->
  <div class="top-grid">
    <!-- Spalte 1: HEUTE â€“ Valentin: Stundenplan & Termine -->
    <section class="card">
      <h3>Heute Â· Valentin â€“ Stundenplan & Termine</h3>
      <div style="display:grid;gap:6px;grid-template-rows:auto auto">
        <div class="iframe-wrap" style="padding:6px">
          <table>
            <thead>
              <tr><th>Zeit</th><th>Fach</th><th>Raum</th></tr>
            </thead>
            <tbody id="stundenplan-heute"></tbody>
          </table>
        </div>
        <div class="iframe-wrap" style="padding:6px">
          <div style="font-weight:600;margin:2px 0 6px 0">Termine Â· Heute</div>
          <ul id="valentin-today-list" style="list-style:none;margin:0;padding:0"></ul>
          <div id="valentin-today-status" style="margin-top:6px;color:#666;font-size:12px"></div>
          <div id="valentin-today-fallback" style="display:none;margin-top:6px">
            <iframe id="valentin-today" height="200" loading="lazy"></iframe>
          </div>
        </div>
      </div>
    </section>

    <!-- Spalte 2: MORGEN â€“ Valentin -->
    <section class="card">
      <h3>Morgen Â· Valentin â€“ Stundenplan & Termine</h3>
      <div style="display:grid;gap:6px;grid-template-rows:auto auto">
        <div class="iframe-wrap" style="padding:6px">
          <table>
            <thead>
              <tr><th>Zeit</th><th>Fach</th><th>Raum</th></tr>
            </thead>
            <tbody id="stundenplan-morgen"></tbody>
          </table>
        </div>
        <div class="iframe-wrap" style="padding:6px">
          <div style="font-weight:600;margin:2px 0 6px 0">Termine Â· Morgen</div>
          <ul id="valentin-tomorrow-list" style="list-style:none;margin:0;padding:0"></ul>
          <div id="valentin-tomorrow-status" style="margin-top:6px;color:#666;font-size:12px"></div>
          <div id="valentin-tomorrow-fallback" style="display:none;margin-top:6px">
            <iframe id="valentin-tomorrow" height="220" loading="lazy"></iframe>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- ===== MITTLERER BEREICH: FIXER STUNDENPLAN ===== -->
  <section class="card">
    <h3>Fixer Stundenplan (Schuljahr)</h3>
    <div style="overflow:auto">
      <table>
        <thead>
          <tr><th>Zeit</th><th>Mo</th><th>Di</th><th>Mi</th><th>Do</th><th>Fr</th></tr>
        </thead>
        <tbody id="stundenplan-fix"><!-- Hier bitte die echten Stundenplandaten eintragen --></tbody>
      </table>
    </div>
  </section>

  <!-- ===== UNTERER BEREICH: Zusammengefasste Ãœbersicht ===== -->
  <section class="card">
    <h3>Woche Â· Dienstplan + Sonstige Termine + Geburtstage + Valentin</h3>
    <div class="iframe-wrap"><iframe id="combined-week" height="300" loading="lazy"></iframe></div>
  </section>

</div>

<script>
  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyw8-Ns-eaFBpr_aMXYxx8RNujRoZ3X89Txu61Zqf9N_TiO1xGviCLB9hqtKnYUeBdk/exec';

  const CAL = {
    VALENTIN: '057e175cb88528446a3b90c6e6ff1124f870e0d6b97ded0da00e1fce8e509188@group.calendar.google.com',
    GENERAL:  'gabstaschill@gmail.com',
    DIENST:   'emujcvc9sc89j8gi2l9kdvf1i0@group.calendar.google.com',
    BDAY:     'addressbook#contacts@group.v.calendar.google.com'
  };

  function toYMD(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0'); return `${y}${m}${da}`; }
  function toISO(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
  function toTimeStr(d){ return new Date(d).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'}); }
  function buildBase(params){ const base='https://calendar.google.com/calendar/embed?'; const common=['ctz=Europe/Berlin','showTitle=0','showPrint=0','showCalendars=0','showTz=0','wkst=2']; return base + [...common, ...params].join('&'); }
  function urlAgendaDay(calIds, ymd){
    // Google Embed erwartet ein Intervall; wir geben den Folgetag als exklusives Ende mit
    const d = ymd;
    const year = parseInt(d.slice(0,4),10);
    const month = parseInt(d.slice(4,6),10)-1;
    const day = parseInt(d.slice(6,8),10);
    const start = new Date(year, month, day);
    const end = new Date(start); end.setDate(start.getDate()+1);
    const endY = end.getFullYear();
    const endM = String(end.getMonth()+1).padStart(2,'0');
    const endD = String(end.getDate()).padStart(2,'0');
    const endYMD = `${endY}${endM}${endD}`;
    const srcs = calIds.map(id=>`src=${encodeURIComponent(id)}`);
    return buildBase(['mode=AGENDA',`dates=${ymd}/${endYMD}`,...srcs]);
  }`); return buildBase(['mode=AGENDA',`dates=${ymd}/${ymd}`,...srcs]); }
  function urlWeek(calIds){ const srcs = calIds.map(id=>`src=${encodeURIComponent(id)}`); return buildBase(['mode=WEEK',...srcs]); }

  const now = new Date();
  const TODAY_YMD = toYMD(now);
  const TOMORROW_DATE = new Date(now); TOMORROW_DATE.setDate(now.getDate()+1);
  const TOMORROW_YMD = toYMD(TOMORROW_DATE);
  const TODAY_ISO = toISO(now);
  const TOMORROW_ISO = toISO(TOMORROW_DATE);

  // Fallback-Iframes immer setzen, damit bei Script-Ausfall etwas sichtbar ist
  document.getElementById('valentin-today').src = urlAgendaDay([CAL.VALENTIN], TODAY_YMD);
  document.getElementById('valentin-tomorrow').src = urlAgendaDay([CAL.VALENTIN], TOMORROW_YMD);

  document.getElementById('combined-week').src = urlWeek([CAL.GENERAL, CAL.DIENST, CAL.BDAY, CAL.VALENTIN]);

  // Stundenplan Beispiel
  const stHeute = document.getElementById('stundenplan-heute');
  const stMorgen = document.getElementById('stundenplan-morgen');
  const testLessonsToday = [
    {time:'08:00â€“08:45',subject:'Mathe',room:'101',cls:'fach-mathe'},
    {time:'09:00â€“09:45',subject:'Englisch',room:'204',cls:'fach-englisch'},
    {time:'10:00â€“10:45',subject:'Deutsch',room:'112',cls:'fach-deutsch'}
  ];
  const testLessonsTomorrow = [
    {time:'08:00â€“08:45',subject:'Deutsch',room:'101',cls:'fach-deutsch'},
    {time:'09:00â€“09:45',subject:'Mathe',room:'204',cls:'fach-mathe'},
    {time:'10:00â€“10:45',subject:'Sport',room:'Halle',cls:'fach-sport'}
  ];
  stHeute.innerHTML  = testLessonsToday.map(l=>`<tr><td>${l.time}</td><td class=\"${l.cls}\">${l.subject}</td><td>${l.room}</td></tr>`).join('');
  stMorgen.innerHTML = testLessonsTomorrow.map(l=>`<tr><td>${l.time}</td><td class=\"${l.cls}\">${l.subject}</td><td>${l.room}</td></tr>`).join('');

  async function function computeDates(){
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth()+1).padStart(2,'0');
    const d = String(now.getDate()).padStart(2,'0');
    const TODAY_ISO = `${y}-${m}-${d}`;
    const TODAY_YMD = `${y}${m}${d}`;
    const tmr = new Date(now); tmr.setDate(now.getDate()+1);
    const ty = tmr.getFullYear();
    const tm = String(tmr.getMonth()+1).padStart(2,'0');
    const td = String(tmr.getDate()).padStart(2,'0');
    const TOMORROW_ISO = `${ty}-${tm}-${td}`;
    const TOMORROW_YMD = `${ty}${tm}${td}`;
    return { TODAY_ISO, TODAY_YMD, TOMORROW_ISO, TOMORROW_YMD };
  }

  function refreshAll(){
    const d = computeDates();
    // Setze Fallback-Iframes vorab, damit immer etwas sichtbar ist
    const todayIframeBox = document.getElementById('valentin-today-fallback');
    const todayIframe = document.getElementById('valentin-today');
    const tmrIframeBox = document.getElementById('valentin-tomorrow-fallback');
    const tmrIframe = document.getElementById('valentin-tomorrow');
    if(todayIframe){ todayIframe.src = urlAgendaDay([CAL.VALENTIN], d.TODAY_YMD); todayIframeBox.style.display='block'; }
    if(tmrIframe){ tmrIframe.src = urlAgendaDay([CAL.VALENTIN], d.TOMORROW_YMD); tmrIframeBox.style.display='block'; }

    loadDayEvents(
      document.getElementById('valentin-today-list'),
      document.getElementById('valentin-today-status'),
      todayIframeBox,
      todayIframe,
      CAL.VALENTIN,
      d.TODAY_ISO,
      d.TODAY_YMD
    );
    loadDayEvents(
      document.getElementById('valentin-tomorrow-list'),
      document.getElementById('valentin-tomorrow-status'),
      tmrIframeBox,
      tmrIframe,
      CAL.VALENTIN,
      d.TOMORROW_ISO,
      d.TOMORROW_YMD
    );
    const week = document.getElementById('combined-week');
    week.src = urlWeek([CAL.GENERAL, CAL.DIENST, CAL.BDAY, CAL.VALENTIN]) + `&v=${Date.now()}`;
  }`;
  }

  // Initial laden
  refreshAll();
  // Alle 5 Minuten automatisch aktualisieren
  setInterval(refreshAll, 5 * 60 * 1000);
  // ===== Auto-Reload alle 5 Minuten =====
  setInterval(()=>{
    loadDayEvents(
      document.getElementById('valentin-today-list'),
      document.getElementById('valentin-today-status'),
      document.getElementById('valentin-today-fallback'),
      document.getElementById('valentin-today'),
      CAL.VALENTIN,
      TODAY_ISO,
      TODAY_YMD
    );
    loadDayEvents(
      document.getElementById('valentin-tomorrow-list'),
      document.getElementById('valentin-tomorrow-status'),
      document.getElementById('valentin-tomorrow-fallback'),
      document.getElementById('valentin-tomorrow'),
      CAL.VALENTIN,
      TOMORROW_ISO,
      TOMORROW_YMD
    );
  }, 5*60*1000);
</script>
</body>
</html>
